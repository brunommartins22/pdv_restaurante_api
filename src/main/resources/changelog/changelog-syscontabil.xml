<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog" 
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    
        
    <changeSet id="1" author="adam"   runOnChange="true">        
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from seguranca.sistema where id = 1</sqlCheck>
        </preConditions>
        <sql splitStatements="true" dbms="postgresql">
            INSERT INTO 
            seguranca.sistema (id, dominio_grupo_sistema,nome_sistema)
            VALUES (1, 'SYSCONTABIL', 'SysContábil');
            VALUES (2, 'ERP', 'Financeiro');
            
        </sql>
    </changeSet>
    
    <changeSet id="1" author="joao"   runOnChange="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from seguranca.empresa where id = 1</sqlCheck>
        </preConditions>        
        <sql splitStatements="true" dbms="postgresql">
            INSERT INTO 
            seguranca.empresa (id, razao_social, cnpj_cpf, ie_rg, tipo_pessoa, rgcodusu, rgusuario, rgdata, rgevento)
            VALUES (1, 'TESTE', '00.000.000/0000-00', '0', 'JURIDICA', 1, 'INTER', now(), 1);
        </sql>
    </changeSet>
    
    <changeSet id="2" author="adam"   runOnChange="true">        
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from seguranca.permissao where id = '1'</sqlCheck>
        </preConditions>
        <sql splitStatements="true" dbms="postgresql">
            
            INSERT INTO seguranca.permissao VALUES ('1', 'Cadastro', null);
            INSERT INTO seguranca.permissao VALUES ('1.01', 'Cadastro de Cliente', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.01.01', '     Incluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.01.02', '     Alterar', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.01.03', '     Excluir', 'CADASTRO');            
            INSERT INTO seguranca.permissao VALUES ('1.02', 'Cadastro de Cidade', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.02.01', '     Incluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.02.02', '     Alterar', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.02.03', '     Excluir', 'CADASTRO');            
            INSERT INTO seguranca.permissao VALUES ('1.03', 'Cadastro de Usuário', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.03.01', '     Incluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.03.02', '     Alterar', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.03.03', '     Excluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.03.04', '     Conceder Permissão', 'PROCESSO');            
            INSERT INTO seguranca.permissao VALUES ('1.04', 'Cadastro de Empresa', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.04.01', '     Incluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.04.02', '     Alterar', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.04.03', '     Excluir', 'CADASTRO');            
            INSERT INTO seguranca.permissao VALUES ('1.05', 'Cadastro de Produto Geral', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.05.01', '     Incluir', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.05.02', '     Alterar', 'CADASTRO');
            INSERT INTO seguranca.permissao VALUES ('1.05.03', '     Excluir', 'CADASTRO');            
            INSERT INTO seguranca.permissao VALUES ('2', 'Processos', null);
            INSERT INTO seguranca.permissao VALUES ('2.01', 'Regra de tributação', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.02', 'Produtos do Cliente', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.02.01', '     Excessão por NCM', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.02.02', '     Excessão por Produção', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.02.03', '     Confirmação de Item', 'PROCESSO');
        </sql>
    </changeSet>
    
    <changeSet id="3" author="adam"   runOnChange="true">        
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from seguranca.permissao_sistema where id = 1</sqlCheck>
        </preConditions>
        <sql splitStatements="true" dbms="postgresql">
            --
            -- TOC entry 2301 (class 0 OID 42598)
            -- Dependencies: 185
            -- Data for Name: permissao_sistema; Type: TABLE DATA; Schema: seguranca; Owner: interage
            --
            INSERT INTO seguranca.permissao_sistema VALUES (1, '1', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (2, '1.01', 1);            
            INSERT INTO seguranca.permissao_sistema VALUES (3, '1.01.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (4, '1.01.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (5, '1.01.03', 1);            
            INSERT INTO seguranca.permissao_sistema VALUES (6, '1.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (7, '1.02.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (8, '1.02.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (9, '1.02.03', 1);            
            INSERT INTO seguranca.permissao_sistema VALUES (10, '1.03', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (11, '1.03.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (12, '1.03.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (13, '1.03.03', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (14, '1.03.04', 1);            
            INSERT INTO seguranca.permissao_sistema VALUES (15, '1.04', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (16, '1.04.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (17, '1.04.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (18, '1.04.03', 1);    
            
            INSERT INTO seguranca.permissao_sistema VALUES (19, '1.05', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (20, '1.05.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (21, '1.05.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (22, '1.05.03', 1);
            
            INSERT INTO seguranca.permissao_sistema VALUES (23, '2', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (24, '2.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (25, '2.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (26, '2.02.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (27, '2.02.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (28, '2.02.03', 1);
        </sql>
    </changeSet>
    
    <changeSet id="4" author="joao" runOnChange="true">        
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.regra_regime_tributario
            ADD CONSTRAINT uk_regime_tributario_id UNIQUE(regime_tributario_id);
        </sql>
    </changeSet>

    <changeSet id="5" author="syscontabil-bruno-joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.cliente
            ALTER COLUMN tipo_cliente TYPE seguranca."DominioTipoPessoa";
            
            ALTER TABLE syscontabil.cliente
            ALTER COLUMN tipo_cliente SET NOT NULL;
        </sql>
    </changeSet>
    
    <changeSet id="6" author="syscontabil-bruno-joao"   runOnChange="true">        
        <sql splitStatements="true" dbms="postgresql">
            CREATE DOMAIN syscontabil."DominioRegime"
            AS character varying(20)
            CONSTRAINT "DominioRegime" CHECK (value in ('LUCROPRESUMIDO','LUCROREAL','SIMPLESNACIONAL'));
            ALTER DOMAIN syscontabil."DominioRegime"
            OWNER TO interage;
        </sql>
    </changeSet>
        
    <changeSet id="7" author="syscontabil-bruno-joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.cliente
            ALTER COLUMN tipo_regime TYPE syscontabil."DominioRegime";
        </sql>
    </changeSet> 
    <changeSet id="8" author="syscontabil-bruno-joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.regra_regime_tributario
            ALTER COLUMN regime_tributario_id TYPE syscontabil."DominioRegime";
        </sql>
    </changeSet> 
    
    <changeSet id="9" author="syscontabil-bruno-joao"   runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            CREATE DOMAIN syscontabil."DominioValidacaoProduto"
            AS character varying(12)
            CONSTRAINT "DominioValidacaoProduto" CHECK (value in ('PENDENTE','VALIDADO'));
            ALTER DOMAIN syscontabil."DominioValidacaoProduto"
            OWNER TO interage;
        </sql>
    </changeSet>
    
    <changeSet id="10" author="syscontabil-bruno-joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.produto_cliente
            ALTER COLUMN status TYPE syscontabil."DominioValidacaoProduto";
        </sql>
    </changeSet>
    
    <changeSet id="11" author="joao" runOnChange="true">        
        <sql splitStatements="true" dbms="postgresql">
            INSERT INTO seguranca.permissao VALUES ('2.01.01', '     Excessão por Regime', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.01.01', '         Incluir', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.01.02', '         Alterar', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.01.03', '         Excluir', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.02', '     Excessão por NCM', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.02.01', '         Incluir', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.02.02', '         Alterar', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.02.03', '         Excluir', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.03', '     Excessão por CNAE', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.03.01', '         Incluir', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.03.02', '         Alterar', 'PROCESSO');
            INSERT INTO seguranca.permissao VALUES ('2.01.03.03', '         Excluir', 'PROCESSO');
        </sql>
    </changeSet>
    
    <changeSet id="12" author="joao"   runOnChange="true">        
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from seguranca.permissao_sistema where id = 25</sqlCheck>
        </preConditions>
        <sql splitStatements="true" dbms="postgresql">
            
            INSERT INTO seguranca.permissao_sistema VALUES (25, '2.01.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (26, '2.01.01.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (27, '2.01.01.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (28, '2.01.01.03', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (29, '2.01.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (30, '2.01.02.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (31, '2.01.02.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (32, '2.01.02.03', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (33, '2.01.03', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (34, '2.01.03.01', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (35, '2.01.03.02', 1);
            INSERT INTO seguranca.permissao_sistema VALUES (36, '2.01.03.03', 1);
        </sql>
    </changeSet>
    
    
    <changeSet id="13" author="renatosm"   runOnChange="true">        
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">SELECT count(*)
                FROM pg_catalog.pg_constraint con
                where con.conname = 'produto_geral_chk_1'</sqlCheck>
        </preConditions>
        <sql splitStatements="true" dbms="postgresql">            
            ALTER TABLE syscontabil.produto_geral
            ADD CONSTRAINT produto_geral_chk_1 CHECK (length(ean::varchar) = 8
            or length(ean::varchar) = 12
            or length(ean::varchar) = 13
            or length(ean::varchar) = 14);
        </sql>
    </changeSet>
    
    <changeSet id="14" author="syscontabil-bruno-joao"   runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            CREATE DOMAIN syscontabil."DominioRegras"
            AS character varying(12)
            CONSTRAINT "DominioRegras" CHECK (value in ('PRODUTO','NCM','REGIME'));
            ALTER DOMAIN syscontabil."DominioRegras"
            OWNER TO interage;
        </sql>
    </changeSet>
    
    <changeSet id="15" author="syscontabil-bruno-joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            ALTER TABLE syscontabil.produto_cliente
            ALTER COLUMN regras TYPE syscontabil."DominioRegras";
        </sql>
    </changeSet>
    
    <changeSet id="16" author="joao" runOnChange="true">
        <sql splitStatements="true" dbms="postgresql">
            INSERT INTO SYSCONTABIL.CONFIGURACAO(id, caminho_upload) VALUES (1, 'C:/Syscontabil');
        </sql>
    </changeSet>
        
    
</databaseChangeLog>
